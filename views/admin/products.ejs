<%- include('head.ejs') %>

    <div class="product-wrapper">
        <div class="productsNav mt-3 mb-5">
            <button class="btn btn-success" id="openAddProduct">Add Products</button>
            <div class="searchBar">
                <input type="search" placeholder="Search for products by name or category" id="productSearch">
                <i class="las la-search"></i>
            </div>
        </div>
        <div class="div tableWrapper">
            <table class="table table-light">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Product Name</th>
                        <th scope="col">Category</th>
                        <th scope="col">Price</th>
                        <th scope="col">Items Left</th>
                        <th scope="col">Image</th>
                        <th scope="col">Actions</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <% product.map((product, index)=> { %>
                        <tr class="product-row">
                            <th scope="row">
                                <%= index + 1 %>
                            </th>
                            <td class="product-name">
                                <%= product.Productname %>
                            </td>
                            <td class="product-category">
                                <%= product.Category %>
                            </td>
                            <td>
                                $<%= product.Price %>
                            </td>
                            <td>
                                <%= product.Stoke %>
                            </td>
                            <td><img src="<%= product.Imagepath[0] %>"
                                    style="width: 40px;height: 40px;object-fit: cover;border-radius: 10px;"></td>
                            <td>
                                <button class="btn btn-primary openEditBtn" onclick="editClick({
                                        pid:`<%= product._id %>`,
                                        pname:`<%= product.Productname %>`,
                                        category: `<%= product.Category %>`,
                                        specs: `<%= product.Spec %>`,
                                        desc: `<%= product.Description %>`,
                                        price: `<%= product.Price %>`,
                                        scost: `<%= product.Shipingcost %>`,
                                        discount: `<%= product.Discount %>`,
                                        stoke: `<%= product.Stoke %>`,
                                        images: `<%- product.Imagepath %>`
                                    })">Edit</button>
                            </td>
                            <td>
                                <a href="/admin/deleteproduct/<%= product._id %>" class="btn btn-danger delete-button"
                                    onclick="return confirm('Are you sure you want to delete this product?')">Delete</a>
                            </td>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
        </div>
    </div>
    <!-- ADD PRODUCT FORM... -->
    <div class="popUp" style="display: none;">
        <div><button class="btn btn-danger closeBtn">close</button></div>
        <div class="formDiv">
            <h6 class="text-center">Add new product</h6>
            <form action="/admin/addproduct" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-control" name="pname" value="">
                </div>
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select class="form-label form-control" name="category">
                        <% catagory.map((category, index)=> { %>
                            <option value="<%= category.catagory %>" class=""><%= category.catagory %></option>
                        <% }); %>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Specs</label>
                    <input type="text" class="form-control" name="specs" value="">
                </div>
                <div class="form-floating mb-3">
                    <textarea class="form-control" name="desc"   placeholder="Leave a comment here"
                        id="floatingTextarea"  ></textarea>
                    <label for="floatingTextarea">Description</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Price</label>
                    <input type="number" name="price" class="form-control" value="">
                </div>
                <div class="mb-3">
                    <label class="form-label">Shipping cost</label>
                    <input type="number" name="scost" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Discount amount</label>
                    <input type="number" name="discount" class="form-control" value="">
                </div>
                <div class="mb-3">
                    <label class="form-label">Total stock</label>
                    <input type="number" name="stoke" class="form-control" value="">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select the images</label>
                    <input type="file" class="form-control" id="fileUpload" name="images" value="" multiple>
                </div>
                <div id="imagePreview"></div>
                <button type="submit" class="btn btn-primary">Add product</button>
            </form>
        </div>
    </div>
    <!-- EDIT PRODUCT FORM -->
    <!-- EDIT PRODUCT FORM -->
    <div class="popUp-edit" style="display: none;">
        <div><button class="btn btn-danger closeBtn-edit">close</button></div>
        <div class="formDiv">
            <h6 class="text-center">Edit the product  </h6>
            
            <form  onsubmit="editproduct()" method="post" id="theEditForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-control" name="pname" id="pname">
                </div>
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-control" name="category" id="category">
                </div>
                <div class="mb-3">
                    <label class="form-label">Specs</label>
                    <input type="text" class="form-control" name="specs" id="specs">
                </div>
                <div class="form-floating mb-3">
                    <textarea class="form-control" name="desc" placeholder="Leave a comment here" id="desc"></textarea>
                    <label for="desc">Description</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Price</label>
                    <input type="number" name="price" id="price" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Shipping cost</label>
                    <input type="number" name="scost" id="scost" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Discount amount</label>
                    <input type="number" name="discount" id="discount" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Total stoke</label>
                    <input type="number" name="stoke" id="stoke" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select the images</label>
                    <input type="file" class="form-control" id="editfileUpload" name="images" multiple>
                </div>
                <h6>images</h6>
                <div id="editImagePreview"></div>
                <button type="submit" class="btn btn-primary">Edit product</button>
</form>
        </div> 
    </div>

    <script>
        let productid;

        function editClick(product) {
            productid = product.pid;
            document.getElementById('pname').value = product.pname;
            document.getElementById('category').value = product.category;
            document.getElementById('specs').value = product.specs;
            document.getElementById('desc').value = product.desc;
            document.getElementById('price').value = product.price;
            document.getElementById('scost').value = product.scost;
            document.getElementById('discount').value = product.discount;
            document.getElementById('stoke').value = product.stoke;

            const imgs = product.images.split(',');

            document.getElementById('editImagePreview').innerHTML = '';
            imgs.forEach(function (imageSrc, index) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';

                const img = document.createElement('img');
                img.src = imageSrc;
                img.className = 'm-1';
                img.style.maxWidth = '80px';

                const deleteLink = document.createElement('a');
                deleteLink.innerText = 'Delete';
                deleteLink.className = 'btn btn-danger delete-image-button';
                deleteLink.href = `/admin/delproductimg/${encodeURIComponent(imageSrc)}/${productid}`;

                deleteLink.onclick = function () {
                    // Remove the image container on click
                    imgContainer.remove();
                };

                imgContainer.appendChild(img);
                imgContainer.appendChild(deleteLink);

                document.getElementById('editImagePreview').appendChild(imgContainer);
            });
        }

        
        function editproduct() {
            
            document.querySelector("#theEditForm").action = "/admin/edit/"+productid;
        }
    </script>
    

    <!-- THIS IS THE SCRIPT TO PRIVIEW IMAGES AFTER THE SELECTION -->
    <script>
        const fileInput = document.getElementById('fileUpload');
        const imagePreview = document.getElementById('imagePreview');
        let selectedFiles = [];

        fileInput.addEventListener('change', () => {
            imagePreview.innerHTML = '';
            const files = fileInput.files;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'preview-image';
                    img.src = URL.createObjectURL(file);
                    img.setAttribute('data-index', i);

                    img.addEventListener('click', (event) => {
                        const index = parseInt(event.target.getAttribute('data-index'));
                        selectedFiles = selectedFiles.filter((_, idx) => idx !== index);
                        updateFileInput(selectedFiles);
                        img.remove();
                    });

                    img.addEventListener('mouseover', () => {
                        img.style.opacity = '0.5';
                    });

                    img.addEventListener('mouseout', () => {
                        img.style.opacity = '1';
                    });

                    imagePreview.appendChild(img);
                    selectedFiles.push(file);
                }
            }
            updateFileInput(selectedFiles);
        });

        function updateFileInput(updatedFiles) {
            const updatedFileList = new DataTransfer();
            for (let i = 0; i < updatedFiles.length; i++) {
                updatedFileList.items.add(updatedFiles[i]);
            }
            fileInput.files = updatedFileList.files;
        }

    </script>
    <script>
        const fileInput2 = document.getElementById('editfileUpload');
        const imagePreview2 = document.getElementById('editImagePreview');

        fileInput2.addEventListener('change', () => {
            imagePreview2.innerHTML = '';

            const files = fileInput2.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'preview-image';
                    img.src = URL.createObjectURL(file);
                    imagePreview2.appendChild(img);
                }
            }
        });
    </script>


 
    <script>
        $(document).ready(() => {
            $("#openAddProduct").click(() => {
                $(".popUp").toggle(300);
            })
            $(".closeBtn").click(() => {
                $(".popUp").toggle(300);
            })
        })
    </script>
    <script>
        $(document).ready(() => {
            $(".openEditBtn").click(() => {
                $(".popUp-edit").toggle(300);
            })
            $(".closeBtn-edit").click(() => {
                $(".popUp-edit").toggle(300);
            })
        })
    </script>
    <!-- SEARCHING SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // Select the search input field
            const productSearchInput = document.getElementById('productSearch');

            // Select all product rows
            const productRows = document.querySelectorAll('.product-row');

            productSearchInput.addEventListener('input', () => {
                const searchTerm = productSearchInput.value.toLowerCase();

                // Loop through all product rows and hide those that don't match the search term
                productRows.forEach((row) => {
                    const productName = row.querySelector('.product-name').textContent.toLowerCase();
                    const productCategory = row.querySelector('.product-category').textContent.toLowerCase();

                    if (
                        productName.includes(searchTerm) ||
                        productCategory.includes(searchTerm)
                    ) {
                        row.style.display = 'table-row';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

        })
    </script>

    <%- include('foot.ejs') %>